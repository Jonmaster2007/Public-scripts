local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer

local function GetRoot(char)
    return char and char:FindFirstChild("HumanoidRootPart")
end

-- Time scaling: 1 second per 150 studs
local TIME_PER_STUD = 1/150

function TweenToPosition(positionVector3)
    local char = player.Character
    if not char then return end

    local root = GetRoot(char)
    if not root then return end

    -- Save original states
    local wasRagdoll = getgenv().blockRagdoll
    local wasDamage = getgenv().antiDamageEnabled

    -- Enable protections only if they were off
    local changedRagdoll = false
    local changedDamage = false

    if not wasRagdoll then
        getgenv().blockRagdoll = true
        changedRagdoll = true
    end
    if not wasDamage then
        getgenv().antiDamageEnabled = true
        changedDamage = true
    end

    -- Duration based on distance
    local distance = (positionVector3 - root.Position).Magnitude
    local duration = distance * TIME_PER_STUD

    local tween = TweenService:Create(
        root,
        TweenInfo.new(duration, Enum.EasingStyle.Linear),
        { CFrame = CFrame.new(positionVector3) }
    )
    tween:Play()

    -- Restore protections AFTER tween ends + 1 second
    tween.Completed:Connect(function()
        task.delay(1, function()
            if changedRagdoll then getgenv().blockRagdoll = false end
            if changedDamage then getgenv().antiDamageEnabled = false end
        end)
    end)
end
