-- Flight logic only
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer or Players.PlayerAdded:Wait()

local humanoid, rootPart
local velocity, gyro

-- Flight parameters
local flying = false
local baseSpeed = 20
local maxSpeed = 100
local acceleration = 10
local deceleration = 5
local currentSpeed = baseSpeed
local direction = {forward=false, backward=false, left=false, right=false, up=false, down=false}

-- Character setup
local function setupCharacter(char)
    humanoid = char:WaitForChild("Humanoid")
    rootPart = char:WaitForChild("HumanoidRootPart")

    velocity = Instance.new("BodyVelocity")
    velocity.MaxForce = Vector3.new(1e5, 1e5, 1e5)
    velocity.Velocity = Vector3.zero

    gyro = Instance.new("BodyGyro")
    gyro.MaxTorque = Vector3.new(1e5, 1e5, 1e5)
    gyro.P = 1e5
end

LocalPlayer.CharacterAdded:Connect(setupCharacter)
if LocalPlayer.Character then
    setupCharacter(LocalPlayer.Character)
end

-- Global toggle function
getgenv().toggleFlight = function()
    if not humanoid or not rootPart then return end
    flying = not flying

    if flying then
        humanoid.PlatformStand = true
        currentSpeed = baseSpeed
        velocity.Parent = rootPart
        gyro.Parent = rootPart

        RunService:BindToRenderStep("FlyControl", Enum.RenderPriority.Character.Value, function()
            local cam = Workspace.CurrentCamera
            local move = Vector3.zero
            if direction.forward then move += cam.CFrame.LookVector end
            if direction.backward then move -= cam.CFrame.LookVector end
            if direction.left then move -= cam.CFrame.RightVector end
            if direction.right then move += cam.CFrame.RightVector end
            if direction.up then move += cam.CFrame.UpVector end
            if direction.down then move -= cam.CFrame.UpVector end

            if move.Magnitude > 0 then
                currentSpeed = math.min(currentSpeed + acceleration, maxSpeed)
                velocity.Velocity = move.Unit * currentSpeed
            else
                velocity.Velocity = Vector3.zero
                currentSpeed = math.max(currentSpeed - deceleration, baseSpeed)
            end

            gyro.CFrame = cam.CFrame
        end)
    else
        humanoid.PlatformStand = false
        velocity.Parent = nil
        gyro.Parent = nil
        RunService:UnbindFromRenderStep("FlyControl")
    end
end
