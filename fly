-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

-- Ensure global direction table exists
if not getgenv().direction then
    getgenv().direction = {forward=false, backward=false, left=false, right=false, up=false, down=false}
end

-- Local player
local LocalPlayer = Players.LocalPlayer or Players.PlayerAdded:Wait()
local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")

-- Flight control objects
local velocity = Instance.new("BodyVelocity")
velocity.MaxForce = Vector3.new(1e5, 1e5, 1e5)
velocity.P = 1e5
velocity.Velocity = Vector3.zero

local gyro = Instance.new("BodyGyro")
gyro.MaxTorque = Vector3.new(1e5, 1e5, 1e5)
gyro.P = 1e5
gyro.CFrame = rootPart.CFrame

-- Flight parameters
local flying = false
local baseSpeed = 20
local maxSpeed = 100
local acceleration = 10
local deceleration = 5
local currentSpeed = baseSpeed

-- Handle character respawn
local function setupCharacter(char)
    humanoid = char:WaitForChild("Humanoid")
    rootPart = char:WaitForChild("HumanoidRootPart")

    velocity = Instance.new("BodyVelocity")
    velocity.MaxForce = Vector3.new(1e5, 1e5, 1e5)
    velocity.Velocity = Vector3.zero

    gyro = Instance.new("BodyGyro")
    gyro.MaxTorque = Vector3.new(1e5, 1e5, 1e5)
    gyro.P = 1e5
end

LocalPlayer.CharacterAdded:Connect(setupCharacter)
if LocalPlayer.Character then
    setupCharacter(LocalPlayer.Character)
end

-- Flight toggle function
getgenv().toggleFlight = function()
    flying = not flying

    if flying and rootPart and humanoid then
        humanoid.PlatformStand = true
        currentSpeed = baseSpeed

        velocity.Parent = rootPart
        gyro.Parent = rootPart

        RunService:BindToRenderStep("FlyControl", Enum.RenderPriority.Character.Value, function()
            local cam = Workspace.CurrentCamera
            local move = Vector3.zero

            if getgenv().direction.forward then move += cam.CFrame.LookVector end
            if getgenv().direction.backward then move -= cam.CFrame.LookVector end
            if getgenv().direction.left then move -= cam.CFrame.RightVector end
            if getgenv().direction.right then move += cam.CFrame.RightVector end
            if getgenv().direction.up then move += cam.CFrame.UpVector end
            if getgenv().direction.down then move -= cam.CFrame.UpVector end

            if move.Magnitude > 0 then
                currentSpeed = math.min(currentSpeed + acceleration, maxSpeed)
                velocity.Velocity = move.Unit * currentSpeed
            else
                velocity.Velocity = Vector3.zero
                currentSpeed = math.max(currentSpeed - deceleration, baseSpeed)
            end

            gyro.CFrame = cam.CFrame
        end)
    else
        if humanoid then humanoid.PlatformStand = false end
        if velocity then velocity.Parent = nil end
        if gyro then gyro.Parent = nil end
        RunService:UnbindFromRenderStep("FlyControl")
    end
end

-- Input listeners
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.Keyboard then
        local code = input.KeyCode
        if code == Enum.KeyCode.W then getgenv().direction.forward = true end
        if code == Enum.KeyCode.S then getgenv().direction.backward = true end
        if code == Enum.KeyCode.A then getgenv().direction.left = true end
        if code == Enum.KeyCode.D then getgenv().direction.right = true end
        if code == Enum.KeyCode.Space then getgenv().direction.up = true end
        if code == Enum.KeyCode.LeftControl then getgenv().direction.down = true end
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Keyboard then
        local code = input.KeyCode
        if code == Enum.KeyCode.W then getgenv().direction.forward = false end
        if code == Enum.KeyCode.S then getgenv().direction.backward = false end
        if code == Enum.KeyCode.A then getgenv().direction.left = false end
        if code == Enum.KeyCode.D then getgenv().direction.right = false end
        if code == Enum.KeyCode.Space then getgenv().direction.up = false end
        if code == Enum.KeyCode.LeftControl then getgenv().direction.down = false end
    end
end)

-- Rayfield keybind (place after UI is loaded)
task.defer(function()
    if KTab and KTab.CreateKeybind then
        local FlyKeybind = KTab:CreateKeybind({
            Name = "Fly Keybind",
            CurrentKeybind = "Insert",
            HoldToInteract = false,
            Flag = "FlyKeybind",
            Callback = function()
                getgenv().toggleFlight()
            end
        })
    end
end)
