--!strict

local Players = game:GetService("Players")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local billboards = {} -- [crate] = BillboardGui
local running = false

local MIN_SIZE = 12
local MAX_SIZE = 30
local MAX_DISTANCE = 500

local function getAllCrates()
    local crates = {}
    local debris = workspace:FindFirstChild("Debris")
    if not debris then return crates end

    for _, ad in ipairs(debris:GetChildren()) do
        if ad.Name == "Airdrop" then
            local drop = ad:FindFirstChild("Drop")
            if drop then
                local crate = drop:FindFirstChild("Crate")
                if crate then
                    table.insert(crates, crate)
                end
            end
        end
    end

    return crates
end

local function createBillboard(crate)
    local bb = Instance.new("BillboardGui")
    bb.Size = UDim2.new(0, MAX_SIZE, 0, MAX_SIZE)
    bb.AlwaysOnTop = true
    bb.Adornee = crate
    bb.Name = "AirdropBillboard"
    bb.Parent = playerGui -- important

    local tl = Instance.new("TextLabel")
    tl.Size = UDim2.new(1, 0, 1, 0)
    tl.BackgroundTransparency = 1
    tl.Text = "Airdrop"
    tl.TextScaled = true
    tl.Font = Enum.Font.GothamBold
    tl.TextColor3 = Color3.fromRGB(150, 200, 255)
    tl.Parent = bb

    return bb
end

local function update()
    local crates = getAllCrates()

    -- Mark existing crates
    local present = {}
    for _, crate in ipairs(crates) do
        present[crate] = true

        if not billboards[crate] then
            billboards[crate] = createBillboard(crate)
        end

        local cam = workspace.CurrentCamera
        local dist = (cam.CFrame.Position - crate.Position).Magnitude
        local scale = (dist <= MAX_DISTANCE)
            and (MAX_SIZE - ((dist / MAX_DISTANCE) * (MAX_SIZE - MIN_SIZE)))
            or MIN_SIZE

        billboards[crate].Size = UDim2.new(0, scale, 0, scale)
    end

    -- Remove billboards for crates that disappeared
    for crate, bb in pairs(billboards) do
        if not present[crate] or not crate.Parent then
            bb:Destroy()
            billboards[crate] = nil
        end
    end
end

_G.ToggleAirdropBillboard = function(enabled)
    running = enabled

    if not enabled then
        for _, bb in pairs(billboards) do
            bb:Destroy()
        end
        billboards = {}
        return
    end

    task.spawn(function()
        while running do
            update()
            task.wait(1)
        end
    end)
end
