-- ======= BAG ESP LOADSTRING (READY-TO-PASTE) =======
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer or Players.PlayerAdded:Wait()

-- GLOBAL SETTINGS
getgenv().bagEspEnabled = true
getgenv().ignoredItems = {}
getgenv().bagMaxDistance = 10000
getgenv().showBagText = false
getgenv().selectedItem = nil

getgenv().defaultImportantItems = {
    ["Red Keycard"] = Color3.fromRGB(255, 0, 0),
    ["Orange Keycard"] = Color3.fromRGB(255, 165, 0),
    ["Green Keycard"] = Color3.fromRGB(0, 255, 0),
    ["Purple Keycard"] = Color3.fromRGB(128, 0, 128),
    ["Blue Keycard"] = Color3.fromRGB(0, 100, 230),
    ["Photon Accelerator"] = Color3.fromRGB(102, 0, 51),
    ["Photon Blades"] = Color3.fromRGB(102, 0, 51),
    ["RSH-12"] = Color3.fromRGB(102, 0, 51),
    ["Red Flare Gun"] = Color3.fromRGB(102, 0, 51),
    ["Green Flare Gun"] = Color3.fromRGB(102, 0, 51),
    ["RPG-18"] = Color3.fromRGB(102, 0, 51),
    ["KS-23"] = Color3.fromRGB(102, 0, 51),
    ["RPG-7"] = Color3.fromRGB(102, 0, 51),
    ["P90"] = Color3.fromRGB(102, 0, 51),
    ["Alternator"] = Color3.fromRGB(102, 0, 51),
    ["Operator Vest"] = Color3.fromRGB(102, 0, 51),
    ["Operator Leggings"] = Color3.fromRGB(102, 0, 51),
    ["Operator Helmet"] = Color3.fromRGB(102, 0, 51),
    ["Operator Helmet MK2"] = Color3.fromRGB(102, 0, 51),
    ["Operator Helmet MK1"] = Color3.fromRGB(102, 0, 51),
    ["Commander Helmet"] = Color3.fromRGB(102, 0, 51),
    ["Commander Vest"] = Color3.fromRGB(102, 0, 51),
    ["Commander Leggings"] = Color3.fromRGB(102, 0, 51),
    ["Bladedancer Helmet"] = Color3.fromRGB(102, 0, 51),
    ["Bladedancer Vest"] = Color3.fromRGB(102, 0, 51),
    ["Bladedancer Leggings"] = Color3.fromRGB(102, 0, 51),
}

getgenv().bagESPConnections = {}

-- CLEANUP ESP
getgenv().cleanupBagESP = function()
    for _, v in ipairs(Workspace:GetDescendants()) do
        if v:IsA("BillboardGui") and v.Name == "ESP" then
            v:Destroy()
        end
    end
end

-- GET ITEM INFO
getgenv().bagShowAllItems = getgenv().bagShowAllItems or false
getgenv().lightGrey = Color3.fromRGB(200, 200, 200)

getgenv().getItemInfo = function(mesh)
    local lootTable = mesh:FindFirstChild("LootTable")
    local importantLabels = {}
    local importantColors = {}
    local extraLabels = {}
    local extraColors = {}

    local isImportant = false

    if lootTable then
        for _, item in ipairs(lootTable:GetChildren()) do
            local itemName = item.Name

            -- Ignore items
            if not getgenv().ignoredItems[itemName] then

                -- Important defined item
                if getgenv().defaultImportantItems[itemName] then
                    table.insert(importantLabels, itemName)
                    importantColors[itemName] = getgenv().defaultImportantItems[itemName]
                    isImportant = true

                -- Extra items (shown only when toggle enabled)
                elseif getgenv().bagShowAllItems then
                    table.insert(extraLabels, itemName)
                    extraColors[itemName] = getgenv().lightGrey
                end
            end
        end
    end
    
    -- If nothing important + showBagText -> display "Bag"
    if #importantLabels == 0 and #extraLabels == 0 and getgenv().showBagText then
        table.insert(importantLabels, "Bag")
        importantColors["Bag"] = Color3.new(1, 1, 1)
    end

    -- Combine lists: Extra items FIRST, important items LAST
    local finalLabels = {}

    for _, v in ipairs(extraLabels) do table.insert(finalLabels, v) end
    for _, v in ipairs(importantLabels) do table.insert(finalLabels, v) end

    -- Merge colors
    local finalColors = {}
    for k, v in pairs(extraColors) do finalColors[k] = v end
    for k, v in pairs(importantColors) do finalColors[k] = v end

    return finalLabels, finalColors, isImportant
end


-- CREATE BILLBOARD GUI
getgenv().createBillboardGui = function(labels, colors, adornee, isImportant)
    local oldESP = adornee:FindFirstChild("ESP")
    if oldESP then oldESP:Destroy() end

    local gui = Instance.new("BillboardGui")
    gui.Name = "ESP"
    gui.Adornee = adornee
    gui.Size = UDim2.new(0, 100, 0, 15 * #labels)
    gui.StudsOffset = Vector3.new(0, 2, 0)
    gui.AlwaysOnTop = true

    for i, labelText in ipairs(labels) do
        local lbl = Instance.new("TextLabel")
        lbl.Size = UDim2.new(1, 0, 0, 15)
        lbl.Position = UDim2.new(0, 0, 0, (i - 1) * 15)
        lbl.BackgroundTransparency = 1
        lbl.Text = labelText
        lbl.TextColor3 = colors[labelText] or Color3.new(1, 1, 1)
        lbl.TextStrokeTransparency = 0.5
        lbl.TextScaled = false
        lbl.TextSize = 12
        lbl.Font = Enum.Font.SourceSansBold
        lbl.Parent = gui
    end

    gui.Parent = adornee
end

-- UPDATE ESP
getgenv().updateBagESP = function()
    if not getgenv().bagEspEnabled then return end
    local lootFolder = Workspace:FindFirstChild("Debris") and Workspace.Debris:FindFirstChild("Loot")
    if not lootFolder then return end

    for _, mesh in ipairs(lootFolder:GetChildren()) do
        if mesh:IsA("Model") or mesh:IsA("BasePart") then
            local adornee = mesh:IsA("Model") and (mesh.PrimaryPart or mesh:FindFirstChildWhichIsA("BasePart")) or mesh
            if adornee then
                local labels, colors, isImportant = getgenv().getItemInfo(mesh)
                if #labels > 0 then
                    getgenv().createBillboardGui(labels, colors, adornee, isImportant)
                else
                    -- Remove stale ESP if no items left
                    local oldESP = adornee:FindFirstChild("ESP")
                    if oldESP then oldESP:Destroy() end
                end
            end
        end
    end
end

-- START ESP LOOP (updates every second)
getgenv().startBagESP = function()
    task.spawn(function()
        while getgenv().bagEspEnabled do
            getgenv().updateBagESP()
            task.wait(1)
        end
    end)
end

-- TOGGLE ESP
getgenv().toggleBagESP = function(state)
    getgenv().bagEspEnabled = state
    if state then
        getgenv().startBagESP()
    else
        getgenv().cleanupBagESP()
    end
end

-- Automatically start ESP
getgenv().startBagESP()
