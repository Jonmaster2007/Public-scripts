local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")

-- Helper: find nearest NPC by name
getgenv().findNearestNPCByName = function(name)
    local function validNPC(model)
        local hum = model:FindFirstChildOfClass("Humanoid")
        return hum and hum.Health > 0
    end

    local function safeInsert(tbl, item, seen)
        if seen[item] then return end
        seen[item] = true
        table.insert(tbl, item)
    end

    local function getAllNPCs()
        local found = {}
        local seen = {}
        local folders = {Workspace:FindFirstChild("NPCs"), Workspace:FindFirstChild("TutorialTask"), Workspace:FindFirstChild("TaskAdded"), Workspace:FindFirstChild("TutorialAdded")}
        for _, folder in ipairs(folders) do
            if folder then
                for _, obj in ipairs(folder:GetDescendants()) do
                    if obj:IsA("Model") and validNPC(obj) then
                        safeInsert(found, obj, seen)
                    end
                end
            end
        end
        for _, obj in ipairs(Workspace:GetChildren()) do
            if obj:IsA("Model") and validNPC(obj) then
                safeInsert(found, obj, {}) -- avoid duplicates
            end
        end
        return found
    end

    local nearest
    local playerChar = Players.LocalPlayer.Character
    local hrp = playerChar and playerChar:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end
    local pos = hrp.Position

    for _, npc in ipairs(getAllNPCs()) do
        if string.lower(npc.Name) == name:lower() then
            local npcRoot = npc:FindFirstChild("HumanoidRootPart")
            if npcRoot then
                local dist = (npcRoot.Position - pos).Magnitude
                if not nearest or dist < (nearest.Position - pos).Magnitude then
                    nearest = npcRoot
                end
            end
        end
    end

    return nearest
end

-- Buttons inside the same loadstring
local BrokerBtn = TTab:CreateButton({
    Name = "Goto Nearest Broker",
    Callback = function()
        local npcRoot = getgenv().findNearestNPCByName("Broker")
        if npcRoot then
            local hrp = Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            if hrp then
                local lv = npcRoot.CFrame.LookVector
                lv = Vector3.new(lv.X, 0, lv.Z).Unit
                local targetPos = npcRoot.Position + lv * 5
                getgenv().TweenToPosition(targetPos)
            end
        end
    end,
})

local MerchantBtn = TTab:CreateButton({
    Name = "Goto Nearest Merchant",
    Callback = function()
        local npcRoot = getgenv().findNearestNPCByName("Merchant")
        if npcRoot then
            local hrp = Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            if hrp then
                local lv = npcRoot.CFrame.LookVector
                lv = Vector3.new(lv.X, 0, lv.Z).Unit
                local targetPos = npcRoot.Position + lv * 5
                getgenv().TweenToPosition(targetPos)
            end
        end
    end,
})
