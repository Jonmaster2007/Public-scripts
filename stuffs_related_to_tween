local Workspace = game:GetService("Workspace")

-- Check if a model is a valid NPC
local function validNPC(model)
    if not model or not model:IsA("Model") then return false end
    local hum = model:FindFirstChildOfClass("Humanoid")
    return hum and hum.Health > 0
end

-- Safe insert to avoid duplicates
local function safeInsert(tbl, item, seen)
    if seen[item] then return end
    seen[item] = true
    table.insert(tbl, item)
end

-- Get all NPCs in workspace
local function getAllNPCs()
    local found = {}
    local seen = {}

    local function addFolder(folder)
        if not folder then return end
        for _, descendant in ipairs(folder:GetDescendants()) do
            if descendant:IsA("Model") and validNPC(descendant) then
                safeInsert(found, descendant, seen)
            end
        end
    end

    -- Scan known NPC folders
    local foldersToScan = {"NPCs", "TutorialTask", "TaskAdded", "TutorialAdded"}
    for _, folderName in ipairs(foldersToScan) do
        addFolder(Workspace:FindFirstChild(folderName))
    end

    -- Include top-level models that are not inside scanned folders
    local function isInScannedFolder(obj)
        for _, folderName in ipairs(foldersToScan) do
            local folder = Workspace:FindFirstChild(folderName)
            if folder and obj:IsDescendantOf(folder) then
                return true
            end
        end
        return false
    end

    for _, obj in ipairs(Workspace:GetChildren()) do
        if obj:IsA("Model") and not isInScannedFolder(obj) and validNPC(obj) then
            safeInsert(found, obj, seen)
        end
    end

    return found
end

getgenv().findNearestNPCByName = function(name)
    local Players = game:GetService("Players")
    local Workspace = game:GetService("Workspace")
    
    -- Utility functions
    local function validNPC(model)
        local hum = model:FindFirstChildOfClass("Humanoid")
        return hum and hum.Health > 0
    end

    local function safeInsert(tbl, item, seen)
        if seen[item] then return end
        seen[item] = true
        table.insert(tbl, item)
    end

    -- Find all NPCs
    local function getAllNPCs()
        local found = {}
        local seen = {}
        local folders = {Workspace:FindFirstChild("NPCs"), Workspace:FindFirstChild("TutorialTask"), Workspace:FindFirstChild("TaskAdded"), Workspace:FindFirstChild("TutorialAdded")}
        for _, folder in ipairs(folders) do
            if folder then
                for _, obj in ipairs(folder:GetDescendants()) do
                    if obj:IsA("Model") and validNPC(obj) then
                        safeInsert(found, obj, seen)
                    end
                end
            end
        end
        for _, obj in ipairs(Workspace:GetChildren()) do
            if obj:IsA("Model") and validNPC(obj) then
                safeInsert(found, obj, {}) -- avoid duplicates
            end
        end
        return found
    end

    -- Find nearest NPC by name
    local nearest
    local playerChar = Players.LocalPlayer.Character
    local hrp = playerChar and playerChar:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end
    local pos = hrp.Position

    for _, npc in ipairs(getAllNPCs()) do
        if string.lower(npc.Name) == name:lower() then
            local npcRoot = npc:FindFirstChild("HumanoidRootPart")
            if npcRoot then
                local dist = (npcRoot.Position - pos).Magnitude
                if not nearest or dist < (nearest.Position - pos).Magnitude then
                    nearest = npcRoot
                end
            end
        end
    end

    return nearest
end

